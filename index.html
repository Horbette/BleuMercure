<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimuNeuf - Simulateur Immobilier Neuf</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #025888;
            --primary-light: #0369a1;
            --secondary: #e2d0af;
            --secondary-dark: #d4bd91;
            --tertiary: #e2d0af;
            --tertiary-dark: #d4bd91;
            --accent: #025888;
            --accent-dark: #024575;
            --danger: #e74c3c;
            --success: #2ecc71;
            --info: #025888;
            --light: #ffffff;
            --gray: #bdc3c7;
            --dark: #025888;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--secondary);
            background: var(--primary);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo-text h1 {
            color: var(--primary);
        }

        .logo-text h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 5px;
            font-weight: 800;
        }

        .logo-text p {
            font-size: 1rem;
            color: var(--gray);
        }

        .simulator-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .form-panel {
            flex: 1;
            min-width: 320px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .panel-header {
            margin-bottom: 25px;
            position: relative;
        }

        .panel-header h2 {
            font-size: 1.6rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-header p {
            color: var(--gray);
            margin-top: 5px;
            font-size: 0.95rem;
        }

        .panel-content {
            position: relative;
        }

        .form-section {
            margin-bottom: 25px;
            position: relative;
        }

        .form-section h3 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section h3 i {
            color: var(--secondary);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.95rem;
            color: var(--primary-light);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            color: var(--primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.1);
        }

        .input-addon {
            position: relative;
        }

        .input-addon input {
            padding-right: 40px;
        }

        .input-addon span {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 500;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input {
            margin: 0;
            width: auto;
        }

        .tax-device {
            margin-top: 15px;
            background-color: rgba(26, 188, 156, 0.1);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--secondary);
        }

        .tax-device h4 {
            color: var(--secondary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tax-device p {
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        .tax-device-options {
            margin-top: 10px;
        }

        .tax-device-options label {
            display: block;
            margin-bottom: 5px;
        }

        .tax-device-options select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(26, 188, 156, 0.3);
            background-color: rgba(255, 255, 255, 0.5);
        }

        .results-panel {
            flex: 1.5;
            min-width: 350px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .results-tab-container {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .results-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray);
        }

        .results-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: var(--primary-light);
            font-weight: 500;
            position: relative;
            transition: var(--transition);
        }

        .results-tab.active {
            color: var(--secondary);
        }

        .results-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--secondary);
        }

        .results-tab:hover:not(.active) {
            background-color: rgba(26, 188, 156, 0.05);
        }

        .results-content {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
        }

        .summary-card.primary {
            background-color: rgba(44, 62, 80, 0.04);
            border-left: 4px solid var(--primary);
        }

        .summary-card.success {
            background-color: rgba(46, 204, 113, 0.04);
            border-left: 4px solid var(--success);
        }

        .summary-card.info {
            background-color: rgba(52, 152, 219, 0.04);
            border-left: 4px solid var(--info);
        }

        .summary-card.accent {
            background-color: rgba(155, 89, 182, 0.04);
            border-left: 4px solid var(--accent);
        }

        .summary-card.tertiary {
            background-color: rgba(243, 156, 18, 0.04);
            border-left: 4px solid var(--tertiary);
        }

        .summary-card-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .summary-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-card.primary .summary-card-value {
            color: var(--primary);
        }

        .summary-card.success .summary-card-value {
            color: var(--success);
        }

        .summary-card.info .summary-card-value {
            color: var(--info);
        }

        .summary-card.accent .summary-card-value {
            color: var(--accent);
        }

        .summary-card.tertiary .summary-card-value {
            color: var(--tertiary);
        }

        .summary-card-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .summary-card-trend.positive {
            color: var(--success);
        }

        .summary-card-trend.negative {
            color: var(--danger);
        }

        .summary-card-trend.neutral {
            color: var(--gray);
        }

        .chart-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            height: 300px;
            position: relative;
        }

        .chart-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chart-subtitle {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: normal;
        }

        .chart-canvas {
            width: 100%;
            height: calc(100% - 30px);
        }

        .breakdown-container {
            margin-top: 30px;
        }

        .breakdown-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .breakdown-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .breakdown-name {
            font-weight: 600;
            color: var(--primary);
        }

        .breakdown-value {
            font-weight: 600;
            color: var(--secondary);
        }

        .breakdown-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .breakdown-progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .breakdown-card.acquisition .breakdown-progress {
            background-color: var(--info);
        }

        .breakdown-card.tax-benefit .breakdown-progress {
            background-color: var(--success);
        }

        .breakdown-card.rental-income .breakdown-progress {
            background-color: var(--tertiary);
        }

        .breakdown-card.expenses .breakdown-progress {
            background-color: var(--danger);
        }

        .breakdown-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        .breakdown-detail {
            flex: 1;
            min-width: 150px;
        }

        .breakdown-detail-label {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .breakdown-detail-value {
            color: var(--primary);
        }

        .tax-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .tax-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
        }

        .tax-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }

        .tax-card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.2rem;
            background-color: rgba(26, 188, 156, 0.1);
            color: var(--secondary);
        }

        .tax-card-title {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
        }

        .tax-card-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tax-item {
            display: flex;
            justify-content: space-between;
        }

        .tax-item-label {
            color: var(--primary-light);
            font-size: 0.9rem;
        }

        .tax-item-value {
            font-weight: 600;
            color: var(--primary);
        }

        .tax-item-value.positive {
            color: var(--success);
        }

        .tax-item-value.negative {
            color: var(--danger);
        }

        .tax-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--gray);
            display: flex;
            justify-content: space-between;
            font-weight: 700;
        }

        .tax-total-label {
            color: var(--primary);
        }

        .tax-total-value {
            color: var(--accent);
        }

        .compare-section {
            margin-top: 30px;
        }

        .compare-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .compare-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
        }

        .compare-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
        }

        .compare-card-header {
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .compare-card-title {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
        }

        .compare-card-badge {
            background-color: var(--secondary);
            color: #fff;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .compare-metrics {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .compare-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .compare-metric-label {
            color: var(--primary-light);
            font-size: 0.9rem;
        }

        .compare-metric-value {
            font-weight: 600;
            color: var(--primary);
        }

        .compare-metric-value.positive {
            color: var(--success);
        }

        .compare-metric-value.negative {
            color: var(--danger);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .button-primary {
            background-color: var(--secondary);
            color: #fff;
        }

        .button-primary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2);
        }

        .button-outline {
            background-color: transparent;
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .button-outline:hover {
            background-color: rgba(26, 188, 156, 0.05);
        }

        .data-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: var(--primary-light);
            font-weight: 500;
        }

        .data-value {
            font-weight: 600;
            color: var(--primary);
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--info);
            margin-left: 5px;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--primary);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--primary) transparent transparent transparent;
        }

        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--secondary);
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .branding {
            text-align: center;
            margin-top: 50px;
            color: var(--primary);
            font-size: 0.9rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .simulator-container {
                flex-direction: column;
            }
            
            .form-panel, 
            .results-panel {
                min-width: 100%;
            }
            
            .summary-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .compare-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="logo-text">
                    <h1>Groupe Bleu Mercure</h1>
                    <p>Simulateur de rendement pour l'immobilier neuf</p>
                </div>
            </div>
            <div class="action-buttons">
                <button class="button button-outline" id="resetButton">
                    <i class="fas fa-undo"></i> Réinitialiser
                </button>
                <button class="button button-primary" id="calculateButton">
                    <i class="fas fa-calculator"></i> Calculer
                </button>
            </div>
        </header>

        <div class="simulator-container">
            <!-- Form Panel -->
            <div class="form-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-sliders-h"></i> Paramètres</h2>
                    <p>Entrez les informations de votre investissement immobilier neuf</p>
                </div>
                <div class="panel-content">
                    <!-- Bien section -->
                    <div class="form-section">
                        <h3><i class="fas fa-home"></i> Bien Immobilier</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Type d'acquisition</label>
                                <select id="acquisitionType" onchange="updateNotaryFees()">
                                    <option value="new" selected>Neuf</option>
                                    <option value="old">Ancien</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Type de bien</label>
                                <select id="propertyType">
                                    <option value="apartment">Appartement</option>
                                    <option value="house">Maison</option>
                                    <option value="studio">Studio</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Surface (m²)</label>
                                <div class="input-addon">
                                    <input type="number" id="surface" value="45">
                                    <span>m²</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prix d'achat</label>
                                <div class="input-addon">
                                    <input type="number" id="purchasePrice" value="230000" onchange="updateNotaryFees()">
                                    <span>€</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Localisation</label>
                                <select id="location">
                                    <option value="zone-a-bis">Zone A bis (Paris, Côte d'Azur...)</option>
                                    <option value="zone-a">Zone A (Lyon, Marseille...)</option>
                                    <option value="zone-b1" selected>Zone B1 (Bordeaux, Nantes...)</option>
                                    <option value="zone-b2">Zone B2 (Autres villes moyennes)</option>
                                    <option value="zone-c">Zone C (Petites villes, rural)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financement section -->
                    <div class="form-section">
                        <h3><i class="fas fa-euro-sign"></i> Financement</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frais de notaire <i class="fas fa-info-circle info-tooltip">
                                    <span class="tooltip-text">Calculés automatiquement selon le type d'acquisition</span>
                                </i></label>
                                <div class="input-addon">
                                    <input type="number" id="notaryFees" value="3450" readonly>
                                    <span>€</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frais d'agence</label>
                                <div class="input-addon">
                                    <input type="number" id="agencyFees" value="0" onchange="updateFinancingCalculations()">
                                    <span>€</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Montant total</label>
                                <div class="input-addon">
                                    <input type="number" id="totalCost" value="233450" readonly>
                                    <span>€</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Montant emprunté</label>
                                <div class="input-addon">
                                    <input type="number" id="loanAmount" value="200000" onchange="updatePersonalContribution()">
                                    <span>€</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Apport personnel <i class="fas fa-info-circle info-tooltip">
                                    <span class="tooltip-text">Calculé automatiquement comme la différence entre le coût total et le montant emprunté</span>
                                </i></label>
                                <div class="input-addon">
                                    <input type="number" id="personalContribution" value="33450" readonly>
                                    <span>€</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Taux d'intérêt</label>
                                <div class="input-addon">
                                    <input type="number" id="interestRate" value="2.8" step="0.1">
                                    <span>%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Durée du prêt</label>
                                <div class="input-addon">
                                    <input type="number" id="loanDuration" value="20">
                                    <span>ans</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Assurance prêt <i class="fas fa-info-circle info-tooltip">
                                    <span class="tooltip-text">Taux d'assurance emprunteur annuel</span>
                                </i></label>
                                <div class="input-addon">
                                    <input type="number" id="loanInsurance" value="0.34" step="0.01">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenus locatifs section -->
                    <div class="form-section">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Revenus Locatifs</h3>
                        <div class="form-row">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Modalité de location</label>
                                    <select id="rentalMode" onchange="updateRentalMode()">
                                        <option value="unfurnished" selected>Nu</option>
                                        <option value="furnished">Meublé</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Loyer mensuel estimé</label>
                                <div class="input-addon">
                                    <input type="number" id="monthlyRent" value="650">
                                    <span>€</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Charges annuelles <i class="fas fa-info-circle info-tooltip">
                                    <span class="tooltip-text">Charges de copropriété, taxe foncière, assurance PNO</span>
                                </i></label>
                                <div class="input-addon">
                                    <input type="number" id="annualCharges" value="1200">
                                    <span>€</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Taux de vacance locative</label>
                                <div class="input-addon">
                                    <input type="number" id="vacancyRate" value="3" min="0" max="100">
                                    <span>%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Gestion locative <i class="fas fa-info-circle info-tooltip">
                                    <span class="tooltip-text">Frais de gestion locative en % du loyer</span>
                                </i></label>
                                <div class="input-addon">
                                    <input type="number" id="managementFees" value="7" min="0" max="100">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fiscalité section -->
                    <div class="form-section">
                        <h3><i class="fas fa-balance-scale"></i> Fiscalité</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tranche marginale d'imposition</label>
                                <select id="taxBracket">
                                    <option value="0">0% (Non imposable)</option>
                                    <option value="11">11%</option>
                                    <option value="30" selected>30%</option>
                                    <option value="41">41%</option>
                                    <option value="45">45%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Régime fiscal</label>
                                <select id="taxRegime" onchange="toggleTaxDevice()">
                                    <option value="lmnp">LMNP (Loueur Meublé Non Professionnel)</option>
                                    <option value="lmp">LMP (Loueur Meublé Professionnel)</option>
                                    <option value="normal" selected>Régime réel (Déficit Foncier)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Pinel Tax Device Options -->
                        <div class="tax-device" id="pinel-options" style="display: none;">
                            <h4><i class="fas fa-star"></i> Dispositif Pinel</h4>
                            <p>Réduction d'impôt sur le revenu en contrepartie d'un engagement de location</p>
                            <div class="tax-device-options">
                                <label>Durée d'engagement</label>
                                <select id="pinelDuration">
                                    <option value="6">6 ans (10.5% de réduction)</option>
                                    <option value="9">9 ans (15% de réduction)</option>
                                    <option value="12" selected>12 ans (17.5% de réduction)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- LMNP Tax Device Options -->
                        <div class="tax-device" id="lmnp-options" style="display: none;">
                            <h4><i class="fas fa-chair"></i> Régime LMNP</h4>
                            <p>Location meublée permettant d'amortir le bien et de réduire la fiscalité</p>
                            <div class="tax-device-options">
                                <label>Méthode d'amortissement</label>
                                <select id="lmnpAmortization">
                                    <option value="linear" selected>Linéaire (90% sur 25 ans)</option>
                                    <option value="degressive">Dégressif (80% sur 20 ans)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-tabs">
                    <div class="results-tab active" data-tab="summary">Résumé</div>
                    <div class="results-tab" data-tab="financial">Financier</div>
                    <div class="results-tab" data-tab="tax">Fiscalité</div>
                    <div class="results-tab" data-tab="comparison">Comparaison</div>
                </div>
                
                <div class="results-tab-container">
                    <!-- Summary Tab -->
                    <div class="results-content">
                        <div class="tab-content active" id="summary-tab">
                            <div class="summary-cards">
                                <div class="summary-card primary">
                                    <div class="summary-card-label">Rendement Brut</div>
                                    <div class="summary-card-value" id="gross-yield">3.39%</div>
                                    <div class="summary-card-trend positive" id="gross-yield-trend">
                                        <i class="fas fa-arrow-up"></i> +0.4% vs marché
                                    </div>
                                </div>
                                <div class="summary-card success">
                                    <div class="summary-card-label">Rendement Net</div>
                                    <div class="summary-card-value" id="net-yield">2.61%</div>
                                    <div class="summary-card-trend positive" id="net-yield-trend">
                                        <i class="fas fa-arrow-up"></i> +0.3% vs marché
                                    </div>
                                </div>
                                <div class="summary-card info">
                                    <div class="summary-card-label">Cash-Flow Mensuel</div>
                                    <div class="summary-card-value" id="monthly-cashflow">+42€</div>
                                    <div class="summary-card-trend positive" id="cashflow-trend">
                                        <i class="fas fa-arrow-up"></i> Positif
                                    </div>
                                </div>
                                <div class="summary-card accent">
                                    <div class="summary-card-label">Effort d'Épargne</div>
                                    <div class="summary-card-value" id="savings-effort">15.2%</div>
                                    <div class="summary-card-trend neutral" id="savings-trend">
                                        <i class="fas fa-equals"></i> Moyen
                                    </div>
                                </div>

                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">
                                    Évolution de la rentabilité
                                    <span class="chart-subtitle">Sur 10 ans</span>
                                </div>
                                <canvas class="chart-canvas" id="profitability-chart"></canvas>
                            </div>
                            
                            <div class="breakdown-container">
                                <div class="breakdown-title">Répartition de l'investissement</div>
                                
                                <div class="breakdown-card acquisition">
                                    <div class="breakdown-header">
                                        <div class="breakdown-name">Acquisition</div>
                                        <div class="breakdown-value" id="acquisition-value">235 000 €</div>
                                    </div>
                                    <div class="breakdown-bar">
                                        <div class="breakdown-progress" style="width: 100%"></div>
                                    </div>
                                    <div class="breakdown-details">
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Prix d'achat</div>
                                            <div class="breakdown-detail-value" id="detail-purchase">230 000 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Frais de notaire</div>
                                            <div class="breakdown-detail-value" id="detail-notary">5 000 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Apport personnel</div>
                                            <div class="breakdown-detail-value" id="detail-contribution">35 000 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Emprunt</div>
                                            <div class="breakdown-detail-value" id="detail-loan">200 000 €</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="breakdown-card rental-income">
                                    <div class="breakdown-header">
                                        <div class="breakdown-name">Revenus locatifs (Annuel)</div>
                                        <div class="breakdown-value" id="rental-value">7 800 €</div>
                                    </div>
                                    <div class="breakdown-bar">
                                        <div class="breakdown-progress" style="width: 100%"></div>
                                    </div>
                                    <div class="breakdown-details">
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Loyers perçus</div>
                                            <div class="breakdown-detail-value" id="detail-rent">7 800 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Taux d'occupation</div>
                                            <div class="breakdown-detail-value" id="detail-occupation">97%</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Prix au m²</div>
                                            <div class="breakdown-detail-value" id="detail-price-per-sqm">5 111 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Loyer au m²</div>
                                            <div class="breakdown-detail-value" id="detail-rent-per-sqm">14.4 €</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="breakdown-card expenses">
                                    <div class="breakdown-header">
                                        <div class="breakdown-name">Charges (Annuel)</div>
                                        <div class="breakdown-value" id="expenses-value">7 292 €</div>
                                    </div>
                                    <div class="breakdown-bar">
                                        <div class="breakdown-progress" style="width: 100%"></div>
                                    </div>
                                    <div class="breakdown-details">
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Remboursement prêt</div>
                                            <div class="breakdown-detail-value" id="detail-loan-payment">5 556 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Charges copropriété</div>
                                            <div class="breakdown-detail-value" id="detail-condo">1 200 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Gestion locative</div>
                                            <div class="breakdown-detail-value" id="detail-management">546 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Cash-flow annuel</div>
                                            <div class="breakdown-detail-value" id="detail-annual-cashflow">+508 €</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="breakdown-card tax-benefit">
                                    <div class="breakdown-header">
                                        <div class="breakdown-name">Avantages fiscaux (Annuel)</div>
                                        <div class="breakdown-value" id="tax-benefit-value">1 230 €</div>
                                    </div>
                                    <div class="breakdown-bar">
                                        <div class="breakdown-progress" style="width: 100%"></div>
                                    </div>
                                    <div class="breakdown-details">
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Régime fiscal</div>
                                            <div class="breakdown-detail-value" id="detail-tax-regime">Réel (Déficit Foncier)</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Économie d'impôt</div>
                                            <div class="breakdown-detail-value" id="detail-tax-saving">1 230 €</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Rentabilité fiscale</div>
                                            <div class="breakdown-detail-value" id="detail-tax-yield">0.52%</div>
                                        </div>
                                        <div class="breakdown-detail">
                                            <div class="breakdown-detail-label">Rentabilité globale</div>
                                            <div class="breakdown-detail-value" id="detail-global-yield">3.13%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Tab -->
                        <div class="tab-content" id="financial-tab">
                            <div class="chart-container">
                                <div class="chart-title">
                                    Évolution du cash-flow mensuel
                                    <span class="chart-subtitle">Sur 25 ans</span>
                                </div>
                                <canvas class="chart-canvas" id="cashflow-chart"></canvas>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">
                                    Remboursement du crédit
                                    <span class="chart-subtitle">Capital vs Intérêts</span>
                                </div>
                                <canvas class="chart-canvas" id="loan-chart"></canvas>
                            </div>
                            
                            <div class="data-section">
                                <h3 class="breakdown-title">Détails Financiers</h3>
                                <div class="data-row">
                                    <div class="data-label">Mensualité de crédit</div>
                                    <div class="data-value" id="loan-monthly-payment">463 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Dont intérêts (1ère année)</div>
                                    <div class="data-value" id="interest-first-year">5 600 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Dont assurance</div>
                                    <div class="data-value" id="insurance-amount">56 €/mois</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Coût total du crédit</div>
                                    <div class="data-value" id="total-loan-cost">83 120 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Charges mensuelles moyennes</div>
                                    <div class="data-value" id="monthly-charges">608 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Loyer mensuel estimé</div>
                                    <div class="data-value" id="estimated-monthly-rent">650 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Cash-flow mensuel initial</div>
                                    <div class="data-value" id="initial-monthly-cashflow">+42 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Cash-flow mensuel à 10 ans</div>
                                    <div class="data-value" id="cashflow-10years">+130 €</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Cash-flow mensuel à 20 ans</div>
                                    <div class="data-value" id="cashflow-20years">+463 €</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tax Tab -->
                        <div class="tab-content" id="tax-tab">
                            <div class="tax-summary">
                                <div class="tax-card">
                                    <div class="tax-card-header">
                                        <div class="tax-card-icon">
                                            <i class="fas fa-calculator"></i>
                                        </div>
                                        <div class="tax-card-title">Revenus Fonciers</div>
                                    </div>
                                    <div class="tax-card-content">
                                        <div class="tax-item">
                                            <div class="tax-item-label">Revenus locatifs</div>
                                            <div class="tax-item-value" id="tax-rental-income">7 800 €</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Charges déductibles</div>
                                            <div class="tax-item-value negative" id="tax-deductible-expenses">- 7 292 €</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Intérêts d'emprunt</div>
                                            <div class="tax-item-value negative" id="tax-loan-interest">- 5 600 €</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Amortissements</div>
                                            <div class="tax-item-value negative" id="tax-depreciation">- 0 €</div>
                                        </div>
                                        <div class="tax-total">
                                            <div class="tax-total-label">Résultat fiscal</div>
                                            <div class="tax-total-value" id="tax-fiscal-result">- 5 092 €</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tax-card">
                                    <div class="tax-card-header">
                                        <div class="tax-card-icon">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="tax-card-title">Impact Fiscal</div>
                                    </div>
                                    <div class="tax-card-content">
                                        <div class="tax-item">
                                            <div class="tax-item-label">TMI applicable</div>
                                            <div class="tax-item-value" id="tax-rate">30%</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Économie d'impôts</div>
                                            <div class="tax-item-value positive" id="tax-savings">+ 1 528 €</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Prélèvements sociaux</div>
                                            <div class="tax-item-value negative" id="tax-social-charges">- 0 €</div>
                                        </div>
                                        <div class="tax-item">
                                            <div class="tax-item-label">Réduction Pinel</div>
                                            <div class="tax-item-value positive" id="tax-pinel-reduction">+ 0 €</div>
                                        </div>
                                        <div class="tax-total">
                                            <div class="tax-total-label">Gain fiscal annuel</div>
                                            <div class="tax-total-value" id="tax-annual-gain">1 528 €</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <div class="chart-title">
                                    Évolution des avantages fiscaux
                                    <span class="chart-subtitle">Sur 10 ans</span>
                                </div>
                                <canvas class="chart-canvas" id="tax-chart"></canvas>
                            </div>
                            
                            <div class="data-section">
                                <h3 class="breakdown-title">Impact sur la Rentabilité</h3>
                                <div class="data-row">
                                    <div class="data-label">Rendement locatif brut</div>
                                    <div class="data-value" id="tax-gross-yield">3.39%</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Rendement locatif net</div>
                                    <div class="data-value" id="tax-net-yield">2.61%</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Rendement fiscal</div>
                                    <div class="data-value" id="tax-fiscal-yield">0.65%</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Rendement global (avec fiscalité)</div>
                                    <div class="data-value" id="tax-global-yield">3.26%</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">Gain fiscal total sur 10 ans</div>
                                    <div class="data-value" id="tax-10year-gain">12 950 €</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparison Tab -->
                        <div class="tab-content" id="comparison-tab">
                            <div class="compare-section">
                                <div class="compare-title">Comparaison des régimes fiscaux</div>
                                <div class="compare-grid">
                                    <div class="compare-card">
                                        <div class="compare-card-header">
                                            <div class="compare-card-title">Régime Réel</div>
                                            <div class="compare-card-badge" id="badge-real">Votre choix</div>
                                        </div>
                                        <div class="compare-metrics">
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement brut</div>
                                                <div class="compare-metric-value" id="compare-real-gross">3.39%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement net</div>
                                                <div class="compare-metric-value" id="compare-real-net">2.61%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Avantage fiscal</div>
                                                <div class="compare-metric-value" id="compare-real-tax">0.65%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement global</div>
                                                <div class="compare-metric-value" id="compare-real-global">3.26%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Cash-flow mensuel</div>
                                                <div class="compare-metric-value" id="compare-real-cashflow">+42 €</div>
                                            </div>

                                        </div>
                                    </div>
                                    
                                    <div class="compare-card">
                                        <div class="compare-card-header">
                                            <div class="compare-card-title">LMNP (Meublé)</div>
                                            <div class="compare-card-badge" id="badge-lmnp" style="display: none;">Votre choix</div>
                                        </div>
                                        <div class="compare-metrics">
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement brut</div>
                                                <div class="compare-metric-value" id="compare-lmnp-gross">3.73%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement net</div>
                                                <div class="compare-metric-value" id="compare-lmnp-net">2.87%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Avantage fiscal</div>
                                                <div class="compare-metric-value" id="compare-lmnp-tax">0.92%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Rendement global</div>
                                                <div class="compare-metric-value" id="compare-lmnp-global">3.79%</div>
                                            </div>
                                            <div class="compare-metric">
                                                <div class="compare-metric-label">Cash-flow mensuel</div>
                                                <div class="compare-metric-value" id="compare-lmnp-cashflow">+78 €</div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="branding">
            Groupe Bleu Mercure © 2025 - Simulateur de rendement immobilier neuf | Tous les calculs sont fournis à titre indicatif uniquement
        </div>
        
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notification-text">Simulation calculée avec succès</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
        // Global variables for simulation data
        let simulationData = {
            property: {},
            financial: {},
            rental: {},
            tax: {},
            results: {
                real: {},
                pinel: {},
                lmnp: {}
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            initTabs();
            
            // Initialize charts
            initCharts();
            
            // Calculate initial values
            runFullCalculation();
            
            // Add event listeners to form inputs
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', function() {
                    runFullCalculation();
                });
            });
            
            // Tab switching
            document.querySelectorAll('.results-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });
            
            // Reset button
            document.getElementById('resetButton').addEventListener('click', function() {
                resetForm();
                runFullCalculation();
                showNotification('Valeurs réinitialisées');
            });
            
            // Calculate button
            document.getElementById('calculateButton').addEventListener('click', function() {
                runFullCalculation();
                showNotification('Simulation calculée avec succès');
            });
        });

            function updateNotaryFees() {
            const acquisitionType = document.getElementById('acquisitionType').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            
            // Appliquer le taux approprié (1% pour neuf, 8% pour ancien)
            let notaryFeesRate = acquisitionType === 'new' ? 0.01 : 0.08;
            let notaryFees = purchasePrice * notaryFeesRate;
            
            // Mettre à jour le champ des frais de notaire
            document.getElementById('notaryFees').value = notaryFees.toFixed(0);
            
            // Mettre à jour les calculs de financement
            updateFinancingCalculations();
            }

            function updateFinancingCalculations() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const notaryFees = parseFloat(document.getElementById('notaryFees').value);
            const agencyFees = parseFloat(document.getElementById('agencyFees').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            
            // Calculer le coût total
            const totalCost = purchasePrice + notaryFees + agencyFees;
            document.getElementById('totalCost').value = totalCost.toFixed(0);
            
            // Calculer l'apport personnel
            const personalContribution = totalCost - loanAmount;
            document.getElementById('personalContribution').value = personalContribution.toFixed(0);
            }

            // Met à jour l'apport personnel quand le montant emprunté change
            function updatePersonalContribution() {
                const totalCost = parseFloat(document.getElementById('totalCost').value);
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                
                // Calculer l'apport personnel
                const personalContribution = totalCost - loanAmount;
                document.getElementById('personalContribution').value = personalContribution.toFixed(0);
                
                // Mettre à jour les calculs
                runFullCalculation();
            }

        // Met à jour le mode de location
        function updateRentalMode() {
            const rentalMode = document.getElementById('rentalMode').value;
            const currentRent = parseFloat(document.getElementById('monthlyRent').value);
            
            // Si meublé, suggérer un loyer 10% plus élevé
            if (rentalMode === 'furnished') {
                // Suggérer seulement si le mode a changé
                if (!window.lastRentalMode || window.lastRentalMode !== 'furnished') {
                    if (confirm('Souhaitez-vous appliquer une majoration de 10% au loyer pour la location meublée?')) {
                        document.getElementById('monthlyRent').value = (currentRent * 1.1).toFixed(0);
                    }
                }
            }
            
            // Sauvegarder le mode actuel
            window.lastRentalMode = rentalMode;
            
            // Mettre à jour les calculs
            runFullCalculation();
        }       

        // Initialize tabs
        function initTabs() {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('summary-tab').classList.add('active');
        }
        
        // Activate a specific tab
        function activateTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.results-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.results-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // Toggle tax device options based on selected regime
        function toggleTaxDevice() {
            const taxRegime = document.getElementById('taxRegime').value;
            
            // Hide all tax device options first
            document.getElementById('pinel-options').style.display = 'none';
            document.getElementById('lmnp-options').style.display = 'none';
            
            // Show the selected tax device options
            if (taxRegime === 'pinel') {
                document.getElementById('pinel-options').style.display = 'block';
            } else if (taxRegime === 'lmnp' || taxRegime === 'lmp') {
                document.getElementById('lmnp-options').style.display = 'block';
            }
        }
        
        // Reset form to default values
        function resetForm() {
            // Property section
            document.getElementById('propertyType').value = 'apartment';
            document.getElementById('surface').value = 45;
            document.getElementById('purchasePrice').value = 230000;
            document.getElementById('location').value = 'zone-b1';
            
            // Financing section
            document.getElementById('notaryFees').value = 5000;
            document.getElementById('personalContribution').value = 35000;
            document.getElementById('interestRate').value = 2.8;
            document.getElementById('loanDuration').value = 20;
            document.getElementById('loanInsurance').value = 0.34;
            
            // Rental income section
            document.getElementById('monthlyRent').value = 650;
            document.getElementById('annualCharges').value = 1200;
            document.getElementById('vacancyRate').value = 3;
            document.getElementById('managementFees').value = 7;
            
            // Tax section
            document.getElementById('taxBracket').value = 30;
            document.getElementById('taxRegime').value = 'normal';
            document.getElementById('pinelDuration').value = 12;
            document.getElementById('lmnpAmortization').value = 'linear';
            
            // Update tax device display
            toggleTaxDevice();
        }
        
        // Main function to run all calculations
        function runFullCalculation() {
            // Initialiser les frais de notaire si c'est la première exécution
            if (!window.initialized) {
                updateNotaryFees();
                window.initialized = true;
            }
            
            // Get all form values
            const formData = getFormValues();
            
            // Calculate financial metrics
            calculateFinancialMetrics(formData);
            
            // Calculate rental metrics
            calculateRentalMetrics(formData);
            
            // Calculate tax metrics for different regimes
            calculateTaxMetrics(formData);
            
            // Calculate results for different regimes
            calculateResults(formData);
            
            // Update UI with calculated values
            updateUI();
            
            // Update charts
            updateCharts();
        }
        
                // Get all form values
                function getFormValues() {
            // Property values
            const propertyType = document.getElementById('propertyType').value;
            const acquisitionType = document.getElementById('acquisitionType').value;
            const surface = parseFloat(document.getElementById('surface').value);
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const location = document.getElementById('location').value;
            
            // Financial values
            const notaryFees = parseFloat(document.getElementById('notaryFees').value);
            const agencyFees = parseFloat(document.getElementById('agencyFees').value); 
            const totalCost = purchasePrice + notaryFees + agencyFees;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const personalContribution = totalCost - loanAmount;
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanDuration = parseInt(document.getElementById('loanDuration').value);
            const loanInsurance = parseFloat(document.getElementById('loanInsurance').value) / 100;
            
            // Rental values
            const rentalMode = document.getElementById('rentalMode').value;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
            const annualCharges = parseFloat(document.getElementById('annualCharges').value);
            const vacancyRate = parseFloat(document.getElementById('vacancyRate').value) / 100;
            const managementFees = parseFloat(document.getElementById('managementFees').value) / 100;
            
            // Tax values
            const taxBracket = parseFloat(document.getElementById('taxBracket').value) / 100;
            const taxRegime = document.getElementById('taxRegime').value;
            const lmnpAmortization = document.getElementById('lmnpAmortization').value;
            
            // Store everything in simulationData object
            simulationData.property = {
                type: propertyType,
                acquisitionType: acquisitionType,
                surface,
                purchasePrice,
                location,
                notaryFees,
                agencyFees,
                totalInvestment: totalCost
            };
    
    
            simulationData.financial = {
                personalContribution,
                loanAmount,
                interestRate,
                loanDuration,
                loanInsurance
            };
            
            simulationData.rental = {
                rentalMode,
                monthlyRent,
                annualRent: monthlyRent * 12,
                annualCharges,
                vacancyRate,
                managementFees,
                effectiveAnnualRent: monthlyRent * 12 * (1 - vacancyRate)
            };
            
            simulationData.tax = {
                taxBracket,
                taxRegime,
                lmnpAmortization
            };
            
            return simulationData;
        }
        
        // Calculate financial metrics
        function calculateFinancialMetrics(data) {
            // Calculate monthly loan payment using the formula for fixed rate loans
            const monthlyInterestRate = data.financial.interestRate / 12;
            const numberOfPayments = data.financial.loanDuration * 12;
            
            let monthlyLoanPayment;
            if (monthlyInterestRate === 0) {
                monthlyLoanPayment = data.financial.loanAmount / numberOfPayments;
            } else {
                monthlyLoanPayment = data.financial.loanAmount * 
                    (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / 
                    (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
            }
            
            // Calculate monthly insurance payment
            const monthlyInsurance = (data.financial.loanAmount * data.financial.loanInsurance) / 12;
            
            // Calculate total monthly payment
            const totalMonthlyPayment = monthlyLoanPayment + monthlyInsurance;
            
            // Calculate interest for first year
            let interestFirstYear = 0;
            let remainingPrincipal = data.financial.loanAmount;
            for (let i = 0; i < 12; i++) {
                const interestPayment = remainingPrincipal * monthlyInterestRate;
                const principalPayment = totalMonthlyPayment - interestPayment - monthlyInsurance;
                interestFirstYear += interestPayment;
                remainingPrincipal -= principalPayment;
            }
            
            // Calculate total cost of the loan
            const totalLoanCost = (totalMonthlyPayment * numberOfPayments) - data.financial.loanAmount;
            
            // Store calculated values
            data.financial.monthlyLoanPayment = monthlyLoanPayment;
            data.financial.monthlyInsurance = monthlyInsurance;
            data.financial.totalMonthlyPayment = totalMonthlyPayment;
            data.financial.interestFirstYear = interestFirstYear;
            data.financial.totalLoanCost = totalLoanCost;
            
            // Calculate loan amortization schedule for charts
            const amortizationSchedule = [];
            remainingPrincipal = data.financial.loanAmount;
            let totalInterest = 0;
            let totalPrincipal = 0;
            
            for (let year = 1; year <= data.financial.loanDuration; year++) {
                let yearlyInterest = 0;
                let yearlyPrincipal = 0;
                
                for (let month = 1; month <= 12; month++) {
                    const monthlyInterest = remainingPrincipal * monthlyInterestRate;
                    const monthlyPrincipal = totalMonthlyPayment - monthlyInterest - monthlyInsurance;
                    
                    yearlyInterest += monthlyInterest;
                    yearlyPrincipal += monthlyPrincipal;
                    remainingPrincipal -= monthlyPrincipal;
                }
                
                totalInterest += yearlyInterest;
                totalPrincipal += yearlyPrincipal;
                
                amortizationSchedule.push({
                    year,
                    interest: yearlyInterest,
                    principal: yearlyPrincipal,
                    remainingPrincipal,
                    totalInterest,
                    totalPrincipal
                });
            }
            
            data.financial.amortizationSchedule = amortizationSchedule;
            
            return data;
        }
        
        // Calculate rental metrics
        function calculateRentalMetrics(data) {
            // Calculate effective monthly rent (accounting for vacancy)
            const effectiveMonthlyRent = data.rental.monthlyRent * (1 - data.rental.vacancyRate);
            
            // Calculate monthly management fees
            const monthlyManagementFees = effectiveMonthlyRent * data.rental.managementFees;
            
            // Calculate monthly charges
            const monthlyCharges = data.rental.annualCharges / 12;
            
            // Calculate total monthly expenses
            const totalMonthlyExpenses = data.financial.totalMonthlyPayment + monthlyCharges + monthlyManagementFees;
            
            // Calculate monthly cash flow
            const monthlyCashFlow = effectiveMonthlyRent - totalMonthlyExpenses;
            
            // Calculate gross and net yields
            const grossYield = (data.rental.annualRent / data.property.totalInvestment) * 100;
            const netYield = ((effectiveMonthlyRent * 12 - data.rental.annualCharges - (monthlyManagementFees * 12)) / data.property.totalInvestment) * 100;
            
            // Calculate savings effort (how much of the loan payment is covered by rent)
            const savingsEffort = 100 - ((effectiveMonthlyRent / data.financial.totalMonthlyPayment) * 100);
            
            // Store calculated values
            data.rental.effectiveMonthlyRent = effectiveMonthlyRent;
            data.rental.monthlyManagementFees = monthlyManagementFees;
            data.rental.monthlyCharges = monthlyCharges;
            data.rental.totalMonthlyExpenses = totalMonthlyExpenses;
            data.rental.monthlyCashFlow = monthlyCashFlow;
            data.rental.grossYield = grossYield;
            data.rental.netYield = netYield;
            data.rental.savingsEffort = savingsEffort;
            
            // Calculate cash flow projection for 25 years (assuming 2% annual rent increase)
            const cashFlowProjection = [];
            let currentMonthlyRent = data.rental.monthlyRent;
            let currentMonthlyExpenses = totalMonthlyExpenses;
            
            for (let year = 1; year <= 25; year++) {
                // After loan duration, remove the loan payment from expenses
                if (year > data.financial.loanDuration) {
                    currentMonthlyExpenses = monthlyCharges + (currentMonthlyRent * (1 - data.rental.vacancyRate) * data.rental.managementFees);
                }
                
                const yearlyEffectiveRent = currentMonthlyRent * (1 - data.rental.vacancyRate);
                const yearlyCashFlow = yearlyEffectiveRent - currentMonthlyExpenses;
                
                cashFlowProjection.push({
                    year,
                    monthlyRent: currentMonthlyRent,
                    effectiveMonthlyRent: yearlyEffectiveRent,
                    monthlyExpenses: currentMonthlyExpenses,
                    monthlyCashFlow: yearlyCashFlow
                });
                
                // Increase rent by 2% per year
                currentMonthlyRent *= 1.02;
                
                // Increase charges by 1.5% per year
                if (year < data.financial.loanDuration) {
                    currentMonthlyExpenses = data.financial.totalMonthlyPayment + 
                                          (data.rental.annualCharges / 12) * Math.pow(1.015, year - 1) + 
                                          (currentMonthlyRent * (1 - data.rental.vacancyRate) * data.rental.managementFees);
                } else {
                    currentMonthlyExpenses = (data.rental.annualCharges / 12) * Math.pow(1.015, year - 1) + 
                                          (currentMonthlyRent * (1 - data.rental.vacancyRate) * data.rental.managementFees);
                }
            }
            
            data.rental.cashFlowProjection = cashFlowProjection;
            
            return data;
        }
        
        // Calculate tax metrics
        function calculateTaxMetrics(data) {
            // Calculate fiscal result for the "real" regime (default)
            const rentalIncome = data.rental.effectiveAnnualRent;
            const deductibleExpenses = data.rental.annualCharges + (data.rental.effectiveAnnualRent * data.rental.managementFees);
            const loanInterest = data.financial.interestFirstYear;
            
            // Real regime: can deduct interest
            const realFiscalResult = rentalIncome - deductibleExpenses - loanInterest;
            const realTaxSavings = realFiscalResult < 0 ? Math.abs(realFiscalResult) * data.tax.taxBracket : 0;
            const realSocialCharges = realFiscalResult > 0 ? realFiscalResult * 0.172 : 0;
            const realNetTaxEffect = realTaxSavings - realSocialCharges;
            
            // Pinel regime: tax reduction based on purchase price and duration
            let pinelRate;
            switch(data.tax.pinelDuration) {
                case 6: pinelRate = 0.105; break;  // 10.5% over 6 years
                case 9: pinelRate = 0.15; break;   // 15% over 9 years
                case 12: pinelRate = 0.175; break; // 17.5% over 12 years
                default: pinelRate = 0.175;
            }
            
            const pinelMaxBase = Math.min(data.property.purchasePrice, 300000); // Pinel is capped at 300K
            const pinelYearlyReduction = (pinelMaxBase * pinelRate) / data.tax.pinelDuration;
            
            // LMNP regime: can amortize the property and deduct depreciation
            let lmnpDepreciationRate;
            if (data.tax.lmnpAmortization === 'linear') {
                lmnpDepreciationRate = 0.9 / 25; // 90% of the property over 25 years
            } else {
                lmnpDepreciationRate = 0.8 / 20; // 80% of the property over 20 years
            }
            
            const lmnpDepreciation = data.property.purchasePrice * lmnpDepreciationRate;
            const lmnpFiscalResult = rentalIncome - deductibleExpenses - loanInterest - lmnpDepreciation;
            const lmnpTaxSavings = lmnpFiscalResult < 0 ? Math.abs(lmnpFiscalResult) * data.tax.taxBracket : 0;
            const lmnpSocialCharges = lmnpFiscalResult > 0 ? lmnpFiscalResult * 0.172 : 0;
            const lmnpNetTaxEffect = lmnpTaxSavings - lmnpSocialCharges;
            
            // Store tax values for real regime
            data.tax.real = {
                fiscalResult: realFiscalResult,
                taxSavings: realTaxSavings,
                socialCharges: realSocialCharges,
                netTaxEffect: realNetTaxEffect,
                totalYearlyBenefit: realNetTaxEffect
            };
            
            // Store tax values for Pinel regime
            data.tax.pinel = {
                fiscalResult: rentalIncome - deductibleExpenses, // No interest deduction in Pinel
                taxSavings: 0, // Not based on fiscal result but on reduction
                socialCharges: (rentalIncome - deductibleExpenses) > 0 ? (rentalIncome - deductibleExpenses) * 0.172 : 0,
                pinelReduction: pinelYearlyReduction,
                netTaxEffect: pinelYearlyReduction - ((rentalIncome - deductibleExpenses) > 0 ? (rentalIncome - deductibleExpenses) * 0.172 : 0),
                totalYearlyBenefit: pinelYearlyReduction - ((rentalIncome - deductibleExpenses) > 0 ? (rentalIncome - deductibleExpenses) * 0.172 : 0)
            };
            
            // Store tax values for LMNP regime
            data.tax.lmnp = {
                fiscalResult: lmnpFiscalResult,
                taxSavings: lmnpTaxSavings,
                socialCharges: lmnpSocialCharges,
                depreciation: lmnpDepreciation,
                netTaxEffect: lmnpNetTaxEffect,
                totalYearlyBenefit: lmnpNetTaxEffect
            };
            
            // Fiscal projections over 10 years
            const fiscalProjection = {
                real: [],
                pinel: [],
                lmnp: []
            };
            
            // Assume rent increases by 2% per year and expenses by 1.5%
            let currentRent = data.rental.effectiveAnnualRent;
            let currentExpenses = deductibleExpenses;
            
            for (let year = 1; year <= 10; year++) {
                // Real regime projection
                const realInterest = year <= data.financial.loanDuration ? 
                    data.financial.amortizationSchedule[year-1].interest : 0;
                
                const realResult = currentRent - currentExpenses - realInterest;
                const realTax = realResult < 0 ? Math.abs(realResult) * data.tax.taxBracket : 
                    realResult * -data.tax.taxBracket;
                const realSocial = realResult > 0 ? realResult * -0.172 : 0;
                
                fiscalProjection.real.push({
                    year,
                    rent: currentRent,
                    expenses: currentExpenses,
                    interest: realInterest,
                    fiscalResult: realResult,
                    taxEffect: realTax + realSocial
                });
                
                // Pinel regime projection
                let pinelReduction = 0;
                if (year <= data.tax.pinelDuration) {
                    pinelReduction = pinelYearlyReduction;
                }
                
                const pinelResult = currentRent - currentExpenses;
                const pinelTax = -pinelResult * data.tax.taxBracket;
                const pinelSocial = pinelResult > 0 ? pinelResult * -0.172 : 0;
                
                fiscalProjection.pinel.push({
                    year,
                    rent: currentRent,
                    expenses: currentExpenses,
                    reduction: pinelReduction,
                    fiscalResult: pinelResult,
                    taxEffect: pinelTax + pinelSocial + pinelReduction
                });
                
                // LMNP regime projection
                const lmnpInterest = year <= data.financial.loanDuration ? 
                    data.financial.amortizationSchedule[year-1].interest : 0;
                
                const lmnpResult = currentRent - currentExpenses - lmnpInterest - lmnpDepreciation;
                const lmnpTax = lmnpResult < 0 ? Math.abs(lmnpResult) * data.tax.taxBracket : 
                    lmnpResult * -data.tax.taxBracket;
                const lmnpSocial = lmnpResult > 0 ? lmnpResult * -0.172 : 0;
                
                fiscalProjection.lmnp.push({
                    year,
                    rent: currentRent,
                    expenses: currentExpenses,
                    interest: lmnpInterest,
                    depreciation: lmnpDepreciation,
                    fiscalResult: lmnpResult,
                    taxEffect: lmnpTax + lmnpSocial
                });
                
                // Update for next year
                currentRent *= 1.02;
                currentExpenses *= 1.015;
            }
            
            data.tax.fiscalProjection = fiscalProjection;
            
            return data;
        }
        
        // Calculate final results
        function calculateResults(data) {
            // Base results are the same for all regimes
            const baseResults = {
                grossYield: data.rental.grossYield,
                netYield: data.rental.netYield,
                monthlyCashFlow: data.rental.monthlyCashFlow,
                savingsEffort: data.rental.savingsEffort
            };
            
            // Calculate ROI for each regime
            // ROI = (Annual Net Income + Tax Benefit + Property Appreciation) * 10 / Total Investment
            
            // Assume 1.5% annual property appreciation
            const propertyAppreciation = data.property.purchasePrice * Math.pow(1.015, 10) - data.property.purchasePrice;
            
            // Accumulate 10 years of cash flow
            const cumulativeCashFlow = data.rental.cashFlowProjection
                .slice(0, 10)
                .reduce((acc, year) => acc + (year.monthlyCashFlow * 12), 0);
            
            // Real regime ROI
            const realTaxBenefit = data.tax.fiscalProjection.real
                .reduce((acc, year) => acc + year.taxEffect, 0);
            
            const realRoi = ((cumulativeCashFlow + realTaxBenefit + propertyAppreciation) / data.property.totalInvestment) * 100;
            const realFiscalYield = (data.tax.real.totalYearlyBenefit / data.property.totalInvestment) * 100;
            const realGlobalYield = data.rental.netYield + realFiscalYield;
            
            // LMNP regime ROI
            const lmnpTaxBenefit = data.tax.fiscalProjection.lmnp
                .reduce((acc, year) => acc + year.taxEffect, 0);
            
            // Assuming 10% higher rent for furnished rental in LMNP
            const lmnpCumulativeCashFlow = data.rental.cashFlowProjection
                .slice(0, 10)
                .reduce((acc, year) => acc + ((year.monthlyCashFlow * 1.1) * 12), 0);
            
            const lmnpRoi = ((lmnpCumulativeCashFlow + lmnpTaxBenefit + propertyAppreciation) / data.property.totalInvestment) * 100;
            const lmnpFiscalYield = (data.tax.lmnp.totalYearlyBenefit / data.property.totalInvestment) * 100;
            const lmnpGlobalYield = (data.rental.netYield * 1.1) + lmnpFiscalYield; // 10% higher for furnished
            
            // Store results
            data.results.real = {
                ...baseResults,
                fiscalYield: realFiscalYield,
                globalYield: realGlobalYield,
                roi10: realRoi,
                taxBenefit10: realTaxBenefit,
                cashFlow10: cumulativeCashFlow
            };
            
            data.results.lmnp = {
                grossYield: data.rental.grossYield * 1.1, // 10% higher for furnished
                netYield: data.rental.netYield * 1.1,     // 10% higher for furnished
                monthlyCashFlow: data.rental.monthlyCashFlow * 1.1, // 10% higher for furnished
                savingsEffort: data.rental.savingsEffort * 0.9,    // 10% lower effort due to higher income
                fiscalYield: lmnpFiscalYield,
                globalYield: lmnpGlobalYield,
                roi10: lmnpRoi,
                taxBenefit10: lmnpTaxBenefit,
                cashFlow10: lmnpCumulativeCashFlow
            };
            
            return data;
        }
        
        // Update UI with calculated values
        function updateUI() {
            // Get current tax regime
            const currentRegime = document.getElementById('taxRegime').value;
            let resultsToShow;
            
            // Select the right result set based on the current regime
            switch(currentRegime) {
                case 'lmnp':
                case 'lmp':
                    resultsToShow = simulationData.results.lmnp;
                    document.getElementById('badge-real').style.display = 'none';
                    document.getElementById('badge-lmnp').style.display = 'block';
                    break;
                default: // normal
                    resultsToShow = simulationData.results.real;
                    document.getElementById('badge-real').style.display = 'block';
                    document.getElementById('badge-lmnp').style.display = 'none';
            }
            
            // Update summary tab
            document.getElementById('gross-yield').textContent = resultsToShow.grossYield.toFixed(2) + '%';
            document.getElementById('net-yield').textContent = resultsToShow.netYield.toFixed(2) + '%';
            document.getElementById('monthly-cashflow').textContent = (resultsToShow.monthlyCashFlow >= 0 ? '+' : '') + 
                                                                    resultsToShow.monthlyCashFlow.toFixed(0) + '€';
            document.getElementById('savings-effort').textContent = resultsToShow.savingsEffort.toFixed(1) + '%';

            
            // Update cashflow trend
            const cashflowTrend = document.getElementById('cashflow-trend');
            if (resultsToShow.monthlyCashFlow > 0) {
                cashflowTrend.innerHTML = '<i class="fas fa-arrow-up"></i> Positif';
                cashflowTrend.className = 'summary-card-trend positive';
            } else {
                cashflowTrend.innerHTML = '<i class="fas fa-arrow-down"></i> Négatif';
                cashflowTrend.className = 'summary-card-trend negative';
            }
            

            
            // Update savings trend
            const savingsTrend = document.getElementById('savings-trend');
            if (resultsToShow.savingsEffort < 10) {
                savingsTrend.innerHTML = '<i class="fas fa-arrow-up"></i> Excellent';
                savingsTrend.className = 'summary-card-trend positive';
            } else if (resultsToShow.savingsEffort < 20) {
                savingsTrend.innerHTML = '<i class="fas fa-arrow-up"></i> Bon';
                savingsTrend.className = 'summary-card-trend positive';
            } else if (resultsToShow.savingsEffort < 30) {
                savingsTrend.innerHTML = '<i class="fas fa-equals"></i> Moyen';
                savingsTrend.className = 'summary-card-trend neutral';
            } else {
                savingsTrend.innerHTML = '<i class="fas fa-arrow-down"></i> Élevé';
                savingsTrend.className = 'summary-card-trend negative';
            }
            
            // Update acquisition breakdown
            document.getElementById('acquisition-value').textContent = formatCurrency(simulationData.property.totalInvestment);
            document.getElementById('detail-purchase').textContent = formatCurrency(simulationData.property.purchasePrice);
            document.getElementById('detail-notary').textContent = formatCurrency(simulationData.property.notaryFees);
            document.getElementById('detail-contribution').textContent = formatCurrency(simulationData.financial.personalContribution);
            document.getElementById('detail-loan').textContent = formatCurrency(simulationData.financial.loanAmount);
            
            // Update rental breakdown
            const annualRent = simulationData.rental.effectiveMonthlyRent * 12;
            document.getElementById('rental-value').textContent = formatCurrency(annualRent);
            document.getElementById('detail-rent').textContent = formatCurrency(annualRent);
            document.getElementById('detail-occupation').textContent = (100 - (simulationData.rental.vacancyRate * 100)).toFixed(0) + '%';
            document.getElementById('detail-price-per-sqm').textContent = formatCurrency(simulationData.property.purchasePrice / simulationData.property.surface);
            document.getElementById('detail-rent-per-sqm').textContent = (simulationData.rental.monthlyRent / simulationData.property.surface).toFixed(1) + ' €';
            
            // Update expenses breakdown
            const annualExpenses = simulationData.rental.totalMonthlyExpenses * 12;
            document.getElementById('expenses-value').textContent = formatCurrency(annualExpenses);
            document.getElementById('detail-loan-payment').textContent = formatCurrency(simulationData.financial.totalMonthlyPayment * 12);
            document.getElementById('detail-condo').textContent = formatCurrency(simulationData.rental.annualCharges);
            document.getElementById('detail-management').textContent = formatCurrency(simulationData.rental.monthlyManagementFees * 12);
            document.getElementById('detail-annual-cashflow').textContent = (resultsToShow.monthlyCashFlow >= 0 ? '+' : '') + 
                                                                         formatCurrency(resultsToShow.monthlyCashFlow * 12);
            
            // Update tax benefit breakdown
            const regimeName = currentRegime === 'pinel' ? 'Pinel' : (currentRegime === 'lmnp' || currentRegime === 'lmp' ? 'LMNP' : 'Réel (Déficit Foncier)');
            const annualTaxBenefit = currentRegime === 'pinel' ? 
                                    simulationData.tax.pinel.totalYearlyBenefit : 
                                    (currentRegime === 'lmnp' || currentRegime === 'lmp' ? 
                                     simulationData.tax.lmnp.totalYearlyBenefit : 
                                     simulationData.tax.real.totalYearlyBenefit);
            
            document.getElementById('tax-benefit-value').textContent = formatCurrency(annualTaxBenefit);
            document.getElementById('detail-tax-regime').textContent = regimeName;
            document.getElementById('detail-tax-saving').textContent = formatCurrency(annualTaxBenefit);
            document.getElementById('detail-tax-yield').textContent = resultsToShow.fiscalYield.toFixed(2) + '%';
            document.getElementById('detail-global-yield').textContent = resultsToShow.globalYield.toFixed(2) + '%';
            
            // Update financial tab
            document.getElementById('loan-monthly-payment').textContent = formatCurrency(simulationData.financial.totalMonthlyPayment);
            document.getElementById('interest-first-year').textContent = formatCurrency(simulationData.financial.interestFirstYear);
            document.getElementById('insurance-amount').textContent = formatCurrency(simulationData.financial.monthlyInsurance) + '/mois';
            document.getElementById('total-loan-cost').textContent = formatCurrency(simulationData.financial.totalLoanCost);
            document.getElementById('monthly-charges').textContent = formatCurrency(simulationData.rental.totalMonthlyExpenses);
            document.getElementById('estimated-monthly-rent').textContent = formatCurrency(simulationData.rental.monthlyRent);
            document.getElementById('initial-monthly-cashflow').textContent = (resultsToShow.monthlyCashFlow >= 0 ? '+' : '') + 
                                                                          formatCurrency(resultsToShow.monthlyCashFlow);
            
            // Cashflow at 10 and 20 years
            const cashflow10years = simulationData.rental.cashFlowProjection[9].monthlyCashFlow;
            const cashflow20years = simulationData.rental.cashFlowProjection[19].monthlyCashFlow;
            document.getElementById('cashflow-10years').textContent = (cashflow10years >= 0 ? '+' : '') + formatCurrency(cashflow10years);
            document.getElementById('cashflow-20years').textContent = (cashflow20years >= 0 ? '+' : '') + formatCurrency(cashflow20years);
            
            // Update tax tab
            // Current fiscal values
            let fiscalResult, taxSavings, socialCharges, pinelReduction, taxAnnualGain;
            switch(currentRegime) {
                case 'pinel':
                    fiscalResult = simulationData.tax.pinel.fiscalResult;
                    taxSavings = simulationData.tax.pinel.taxSavings;
                    socialCharges = simulationData.tax.pinel.socialCharges;
                    pinelReduction = simulationData.tax.pinel.pinelReduction;
                    taxAnnualGain = simulationData.tax.pinel.totalYearlyBenefit;
                    break;
                case 'lmnp':
                case 'lmp':
                    fiscalResult = simulationData.tax.lmnp.fiscalResult;
                    taxSavings = simulationData.tax.lmnp.taxSavings;
                    socialCharges = simulationData.tax.lmnp.socialCharges;
                    pinelReduction = 0;
                    taxAnnualGain = simulationData.tax.lmnp.totalYearlyBenefit;
                    break;
                default: // normal
                    fiscalResult = simulationData.tax.real.fiscalResult;
                    taxSavings = simulationData.tax.real.taxSavings;
                    socialCharges = simulationData.tax.real.socialCharges;
                    pinelReduction = 0;
                    taxAnnualGain = simulationData.tax.real.totalYearlyBenefit;
            }
            
            document.getElementById('tax-rental-income').textContent = formatCurrency(simulationData.rental.effectiveAnnualRent);
            document.getElementById('tax-deductible-expenses').textContent = '- ' + formatCurrency(simulationData.rental.annualCharges + (simulationData.rental.effectiveAnnualRent * simulationData.rental.managementFees));
            document.getElementById('tax-loan-interest').textContent = '- ' + formatCurrency(simulationData.financial.interestFirstYear);
            
            // Amortization for LMNP only
            if (currentRegime === 'lmnp' || currentRegime === 'lmp') {
                document.getElementById('tax-depreciation').textContent = '- ' + formatCurrency(simulationData.tax.lmnp.depreciation);
            } else {
                document.getElementById('tax-depreciation').textContent = '- 0 €';
            }
            
            document.getElementById('tax-fiscal-result').textContent = fiscalResult >= 0 ? 
                                                                   formatCurrency(fiscalResult) : 
                                                                   '- ' + formatCurrency(Math.abs(fiscalResult));
            
            document.getElementById('tax-rate').textContent = (simulationData.tax.taxBracket * 100).toFixed(0) + '%';
            document.getElementById('tax-savings').textContent = '+ ' + formatCurrency(taxSavings);
            document.getElementById('tax-social-charges').textContent = '- ' + formatCurrency(socialCharges);
            document.getElementById('tax-pinel-reduction').textContent = '+ ' + formatCurrency(pinelReduction);
            document.getElementById('tax-annual-gain').textContent = formatCurrency(taxAnnualGain);
            
            // Tax impact on returns
            document.getElementById('tax-gross-yield').textContent = resultsToShow.grossYield.toFixed(2) + '%';
            document.getElementById('tax-net-yield').textContent = resultsToShow.netYield.toFixed(2) + '%';
            document.getElementById('tax-fiscal-yield').textContent = resultsToShow.fiscalYield.toFixed(2) + '%';
            document.getElementById('tax-global-yield').textContent = resultsToShow.globalYield.toFixed(2) + '%';
            document.getElementById('tax-10year-gain').textContent = formatCurrency(currentRegime === 'pinel' ? 
                                                                  simulationData.results.pinel.taxBenefit10 : 
                                                                  (currentRegime === 'lmnp' || currentRegime === 'lmp' ? 
                                                                   simulationData.results.lmnp.taxBenefit10 : 
                                                                   simulationData.results.real.taxBenefit10));
            
            // Update comparison tab
            updateComparisonTab();
        }
        
            // Update comparison tab separately
            function updateComparisonTab() {
                // Real regime
                document.getElementById('compare-real-gross').textContent = simulationData.results.real.grossYield.toFixed(2) + '%';
                document.getElementById('compare-real-net').textContent = simulationData.results.real.netYield.toFixed(2) + '%';
                document.getElementById('compare-real-tax').textContent = simulationData.results.real.fiscalYield.toFixed(2) + '%';
                document.getElementById('compare-real-global').textContent = simulationData.results.real.globalYield.toFixed(2) + '%';
                document.getElementById('compare-real-cashflow').textContent = (simulationData.results.real.monthlyCashFlow >= 0 ? '+' : '') + 
                                                                        simulationData.results.real.monthlyCashFlow.toFixed(0) + ' €';
                
                // LMNP regime
                document.getElementById('compare-lmnp-gross').textContent = simulationData.results.lmnp.grossYield.toFixed(2) + '%';
                document.getElementById('compare-lmnp-net').textContent = simulationData.results.lmnp.netYield.toFixed(2) + '%';
                document.getElementById('compare-lmnp-tax').textContent = simulationData.results.lmnp.fiscalYield.toFixed(2) + '%';
                document.getElementById('compare-lmnp-global').textContent = simulationData.results.lmnp.globalYield.toFixed(2) + '%';
                document.getElementById('compare-lmnp-cashflow').textContent = (simulationData.results.lmnp.monthlyCashFlow >= 0 ? '+' : '') + 
                                                                        simulationData.results.lmnp.monthlyCashFlow.toFixed(0) + ' €';
            }
        
        // Initialize charts
        function initCharts() {
            // Profitability Chart
            const profitabilityCtx = document.getElementById('profitability-chart').getContext('2d');
            window.profitabilityChart = new Chart(profitabilityCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 10}, (_, i) => `Année ${i+1}`),
                    datasets: [{
                        label: 'Rendement Global',
                        data: Array(10).fill(0),
                        borderColor: '#1abc9c',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#2c3e50'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashflow-chart').getContext('2d');
            window.cashFlowChart = new Chart(cashFlowCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 25}, (_, i) => `Année ${i+1}`),
                    datasets: [{
                        label: 'Cash-Flow Mensuel',
                        data: Array(25).fill(0),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#2c3e50'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '€';
                                },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Loan Chart
            const loanCtx = document.getElementById('loan-chart').getContext('2d');
            window.loanChart = new Chart(loanCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 10}, (_, i) => `Année ${i+1}`),
                    datasets: [{
                        label: 'Capital',
                        data: Array(10).fill(0),
                        backgroundColor: '#2ecc71'
                    }, {
                        label: 'Intérêts',
                        data: Array(10).fill(0),
                        backgroundColor: '#e74c3c'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#2c3e50'
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '€';
                                },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            stacked: true,
                            ticks: {
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Tax Chart
            const taxCtx = document.getElementById('tax-chart').getContext('2d');
            window.taxChart = new Chart(taxCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 10}, (_, i) => `Année ${i+1}`),
                    datasets: [{
                        label: 'Avantage Fiscal',
                        data: Array(10).fill(0),
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#2c3e50'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '€';
                                },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            

        }
        
        // Update charts with new data
        function updateCharts() {
            const currentRegime = document.getElementById('taxRegime').value;
            let currentResults;
            
            switch(currentRegime) {
                case 'pinel':
                    currentResults = simulationData.results.pinel;
                    break;
                case 'lmnp':
                case 'lmp':
                    currentResults = simulationData.results.lmnp;
                    break;
                default: // normal
                    currentResults = simulationData.results.real;
            }
            
            // Update Profitability Chart - show increasing yield over time
            const yieldData = Array.from({length: 10}, (_, i) => 
                currentResults.globalYield * (1 + (i * 0.03)) // Simplified increasing yield model
            );
            
            window.profitabilityChart.data.datasets[0].data = yieldData;
            window.profitabilityChart.update();
            
            // Update Cash Flow Chart
            const cashFlowData = simulationData.rental.cashFlowProjection.map(year => year.monthlyCashFlow);
            window.cashFlowChart.data.datasets[0].data = cashFlowData;
            window.cashFlowChart.update();
            
            // Update Loan Chart (first 10 years or loan duration, whichever is shorter)
            const yearCount = Math.min(10, simulationData.financial.loanDuration);
            window.loanChart.data.labels = Array.from({length: yearCount}, (_, i) => `Année ${i+1}`);
            
            const principalData = simulationData.financial.amortizationSchedule
                .slice(0, yearCount)
                .map(year => year.principal);
                
            const interestData = simulationData.financial.amortizationSchedule
                .slice(0, yearCount)
                .map(year => year.interest);
            
            window.loanChart.data.datasets[0].data = principalData;
            window.loanChart.data.datasets[1].data = interestData;
            window.loanChart.update();
            
            // Update Tax Chart
            let taxData;
            switch(currentRegime) {
                case 'pinel':
                    taxData = simulationData.tax.fiscalProjection.pinel.map(year => year.taxEffect);
                    break;
                case 'lmnp':
                case 'lmp':
                    taxData = simulationData.tax.fiscalProjection.lmnp.map(year => year.taxEffect);
                    break;
                default: // normal
                    taxData = simulationData.tax.fiscalProjection.real.map(year => year.taxEffect);
            }
            
            window.taxChart.data.datasets[0].data = taxData;
            window.taxChart.update();
            

        }
        
        // Helper function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'decimal',
                maximumFractionDigits: 0
            }).format(value) + ' €';
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
